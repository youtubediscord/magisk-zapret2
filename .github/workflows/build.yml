name: Build Magisk Module

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  NDK_VERSION: r26b
  ZAPRET_REPO: bol-van/zapret2

jobs:
  build-nfqws2:
    name: Build nfqws2 for ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: arm64-v8a
            ndk_arch: aarch64-linux-android
            api: 24
          - arch: armeabi-v7a
            ndk_arch: armv7a-linux-androideabi
            api: 24
          - arch: x86_64
            ndk_arch: x86_64-linux-android
            api: 24
          - arch: x86
            ndk_arch: i686-linux-android
            api: 24

    steps:
      - name: Checkout module
        uses: actions/checkout@v4

      - name: Checkout zapret source
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ZAPRET_REPO }}
          path: zapret-src

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: ${{ env.NDK_VERSION }}
          add-to-path: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential wget autoconf automake libtool pkg-config

      - name: Build libmnl for Android
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
          export CC=$TOOLCHAIN/bin/${{ matrix.ndk_arch }}${{ matrix.api }}-clang
          export AR=$TOOLCHAIN/bin/llvm-ar
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export PREFIX=$GITHUB_WORKSPACE/android-libs

          git clone --depth 1 https://git.netfilter.org/libmnl
          cd libmnl
          ./autogen.sh
          ./configure --host=${{ matrix.ndk_arch }} --prefix=$PREFIX --enable-static --disable-shared
          make -j$(nproc)
          make install

      - name: Build libnfnetlink for Android
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
          export CC=$TOOLCHAIN/bin/${{ matrix.ndk_arch }}${{ matrix.api }}-clang
          export AR=$TOOLCHAIN/bin/llvm-ar
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export PREFIX=$GITHUB_WORKSPACE/android-libs
          export PKG_CONFIG_PATH=$PREFIX/lib/pkgconfig

          git clone --depth 1 https://git.netfilter.org/libnfnetlink
          cd libnfnetlink
          ./autogen.sh
          ./configure --host=${{ matrix.ndk_arch }} --prefix=$PREFIX --enable-static --disable-shared
          make -j$(nproc)
          make install

      - name: Build libnetfilter_queue for Android
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
          export CC=$TOOLCHAIN/bin/${{ matrix.ndk_arch }}${{ matrix.api }}-clang
          export AR=$TOOLCHAIN/bin/llvm-ar
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export PREFIX=$GITHUB_WORKSPACE/android-libs
          export PKG_CONFIG_PATH=$PREFIX/lib/pkgconfig
          export CFLAGS="-I$PREFIX/include"
          export LDFLAGS="-L$PREFIX/lib"

          git clone --depth 1 https://git.netfilter.org/libnetfilter_queue
          cd libnetfilter_queue
          ./autogen.sh
          ./configure --host=${{ matrix.ndk_arch }} --prefix=$PREFIX --enable-static --disable-shared
          make -j$(nproc)
          make install

      - name: Build Lua 5.4 for Android
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          # Download Lua 5.4
          wget -q https://www.lua.org/ftp/lua-5.4.6.tar.gz
          tar xzf lua-5.4.6.tar.gz
          cd lua-5.4.6/src

          # Set up cross-compiler
          TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
          CC=$TOOLCHAIN/bin/${{ matrix.ndk_arch }}${{ matrix.api }}-clang
          AR=$TOOLCHAIN/bin/llvm-ar

          # Build Lua objects
          $CC -std=gnu99 -O2 -Wall -fPIC -DLUA_USE_LINUX -c *.c

          # Create static library
          $AR rcs liblua.a *.o

          # Install to local prefix
          mkdir -p $GITHUB_WORKSPACE/lua-android/lib
          mkdir -p $GITHUB_WORKSPACE/lua-android/include
          cp liblua.a $GITHUB_WORKSPACE/lua-android/lib/
          cp lua.h luaconf.h lualib.h lauxlib.h $GITHUB_WORKSPACE/lua-android/include/

      - name: Build nfqws2 for ${{ matrix.arch }}
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          cd zapret-src/nfq2

          # Set up cross-compiler
          TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
          export CC=$TOOLCHAIN/bin/${{ matrix.ndk_arch }}${{ matrix.api }}-clang
          export AR=$TOOLCHAIN/bin/llvm-ar
          export STRIP=$TOOLCHAIN/bin/llvm-strip

          # Paths to our built libraries
          PREFIX=$GITHUB_WORKSPACE/android-libs
          LUA_PREFIX=$GITHUB_WORKSPACE/lua-android

          # Build with all dependencies
          export CFLAGS="-I$PREFIX/include -I$LUA_PREFIX/include"
          export LDFLAGS="-L$PREFIX/lib -L$LUA_PREFIX/lib"
          export LUA_CFLAGS="-I$LUA_PREFIX/include"
          export LUA_LIB="-L$LUA_PREFIX/lib -llua"
          export LIBS_LINUX="-L$PREFIX/lib -lnetfilter_queue -lnfnetlink -lmnl -lz -lm"

          make android CC=$CC LUA_JIT=0 \
            CFLAGS="$CFLAGS" \
            LDFLAGS="$LDFLAGS" \
            LUA_CFLAGS="$LUA_CFLAGS" \
            LUA_LIB="$LUA_LIB" \
            LIBS_LINUX="$LIBS_LINUX"

          # Strip binary
          $STRIP nfqws2 || true

          # Create output dir
          mkdir -p $GITHUB_WORKSPACE/binaries/${{ matrix.arch }}
          cp nfqws2 $GITHUB_WORKSPACE/binaries/${{ matrix.arch }}/

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: nfqws2-${{ matrix.arch }}
          path: binaries/${{ matrix.arch }}/nfqws2

  package-module:
    name: Package Magisk Module
    runs-on: ubuntu-latest
    needs: build-nfqws2

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          path: binaries

      - name: Prepare module
        run: |
          # Create bin directories
          mkdir -p zapret2/bin/arm64-v8a
          mkdir -p zapret2/bin/armeabi-v7a
          mkdir -p zapret2/bin/x86_64
          mkdir -p zapret2/bin/x86

          # Copy binaries
          cp binaries/nfqws2-arm64-v8a/nfqws2 zapret2/bin/arm64-v8a/ || true
          cp binaries/nfqws2-armeabi-v7a/nfqws2 zapret2/bin/armeabi-v7a/ || true
          cp binaries/nfqws2-x86_64/nfqws2 zapret2/bin/x86_64/ || true
          cp binaries/nfqws2-x86/nfqws2 zapret2/bin/x86/ || true

          # Set version
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION="${VERSION#v}"
          VERSION_CODE=$(echo $VERSION | tr -d '.' | head -c 6)

          sed -i "s/^version=.*/version=v${VERSION}/" module.prop
          sed -i "s/^versionCode=.*/versionCode=${VERSION_CODE}/" module.prop

          # Make scripts executable
          chmod +x customize.sh service.sh uninstall.sh action.sh
          chmod +x zapret2/scripts/*.sh

      - name: Create ZIP
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION="${VERSION#v}"

          zip -r zapret2-magisk-v${VERSION}.zip \
            META-INF \
            module.prop \
            customize.sh \
            service.sh \
            uninstall.sh \
            action.sh \
            zapret2 \
            -x "*.git*" \
            -x "CLAUDE.md" \
            -x ".github/*"

      - name: Upload module
        uses: actions/upload-artifact@v4
        with:
          name: zapret2-magisk-module
          path: zapret2-magisk-*.zip

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: zapret2-magisk-*.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Alternative: Download prebuilt from zapret releases
  package-with-prebuilt:
    name: Package with Prebuilt Binaries
    runs-on: ubuntu-latest
    if: ${{ always() }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Try download prebuilt binaries
        continue-on-error: true
        run: |
          # Try to get latest release info
          RELEASE_INFO=$(curl -s https://api.github.com/repos/bol-van/zapret/releases/latest)

          # Check for android binaries in assets
          echo "Checking for prebuilt Android binaries..."
          echo "$RELEASE_INFO" | jq -r '.assets[].name' || echo "No assets found"

          # If prebuilt available, download them
          # This is a placeholder - adjust when binaries are available
          mkdir -p zapret2/bin/arm64-v8a
          mkdir -p zapret2/bin/armeabi-v7a

      - name: Create placeholder module (no binaries)
        run: |
          VERSION="${{ github.event.inputs.version || '1.0.0' }}"

          # Add note about missing binaries
          echo "NOTE: nfqws2 binaries are not included." > zapret2/bin/README.txt
          echo "Please compile from source or wait for prebuilt releases." >> zapret2/bin/README.txt
          echo "" >> zapret2/bin/README.txt
          echo "Build command:" >> zapret2/bin/README.txt
          echo "  cd zapret/nfq2" >> zapret2/bin/README.txt
          echo "  make android CC=<ndk-clang>" >> zapret2/bin/README.txt

          chmod +x customize.sh service.sh uninstall.sh action.sh 2>/dev/null || true
          chmod +x zapret2/scripts/*.sh 2>/dev/null || true

          zip -r zapret2-magisk-v${VERSION}-nobinary.zip \
            META-INF \
            module.prop \
            customize.sh \
            service.sh \
            uninstall.sh \
            action.sh \
            zapret2 \
            README.md \
            -x "*.git*" \
            -x "CLAUDE.md" \
            -x ".github/*"

      - name: Upload no-binary module
        uses: actions/upload-artifact@v4
        with:
          name: zapret2-magisk-nobinary
          path: zapret2-magisk-*-nobinary.zip
