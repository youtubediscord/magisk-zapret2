name: Build Magisk Module

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

permissions:
  contents: write

jobs:
  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Create keystore
        id: keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          # Decode keystore from secret or generate new one
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | tr -d '[:space:]' | base64 -d > keystore.jks
            echo "generated=false" >> $GITHUB_OUTPUT
          else
            # Generate new keystore
            keytool -genkeypair -v \
              -keystore keystore.jks \
              -alias zapret2 \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass zapret2release \
              -keypass zapret2release \
              -dname "CN=Zapret2, OU=Mobile, O=Zapret2, L=Unknown, ST=Unknown, C=RU"
            echo "generated=true" >> $GITHUB_OUTPUT
            # Output base64 for saving to secrets
            echo "::notice::Keystore generated! Download artifact and add KEYSTORE_BASE64 to secrets"
            echo "KEYSTORE_BASE64 value:"
            base64 -w0 keystore.jks
            echo ""
          fi
        working-directory: android-app

      - name: Upload keystore (if generated)
        if: steps.keystore.outputs.generated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: keystore-save-to-secrets
          path: android-app/keystore.jks
          retention-days: 1

      - name: Build Release APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || 'zapret2release' }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS || 'zapret2' }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD || 'zapret2release' }}
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease
        working-directory: android-app

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: zapret2-apk
          path: android-app/app/build/outputs/apk/release/app-release.apk

  build-nfqws2:
    name: Build nfqws2 for ${{ matrix.abi }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - abi: arm64-v8a
            target: aarch64-linux-android
          - abi: armeabi-v7a
            target: armv7a-linux-androideabi

    steps:
      - name: Checkout module
        uses: actions/checkout@v4

      - name: Checkout zapret2 source
        uses: actions/checkout@v4
        with:
          repository: bol-van/zapret2
          path: zapret2

      - name: Set up build tools
        run: |
          sudo dpkg --add-architecture i386
          sudo apt update -qq
          sudo apt install -y gcc-multilib

      - name: Build
        env:
          ABI: ${{ matrix.abi }}
          API: 21
          TARGET: ${{ matrix.target }}
          GH_TOKEN: ${{ github.token }}
          LUAJIT_VER: 2.1
          LUAJIT_RELEASE: 2.1-20250117
          LUAJIT_LUAVER: 5.1
        run: |
          DEPS_DIR=$GITHUB_WORKSPACE/deps
          export TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
          export CC="$TOOLCHAIN/bin/clang --target=$TARGET$API"
          export AR=$TOOLCHAIN/bin/llvm-ar
          export AS=$CC
          export LD=$TOOLCHAIN/bin/ld
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN/bin/llvm-strip
          export PKG_CONFIG_PATH=$DEPS_DIR/lib/pkgconfig

          # luajit
          wget -qO- https://github.com/openresty/luajit2/archive/refs/tags/v${LUAJIT_RELEASE}.tar.gz | tar -xz
          case "$ABI" in
            *64*)
              HOSTCC="cc"
              ;;
            *)
              HOSTCC="cc -m32"
          esac
          (
            cd luajit2-*
            make BUILDMODE=static XCFLAGS=-DLUAJIT_DISABLE_FFI HOST_CC="$HOSTCC" CROSS= CC="$CC" TARGET_AR="$AR rcus" TARGET_STRIP=$STRIP CFLAGS="-Os -flto=auto $CFLAGS" -j$(nproc)
            make install PREFIX= DESTDIR=$DEPS_DIR
          )
          LJIT=1
          LCFLAGS="-I${DEPS_DIR}/include/luajit-${LUAJIT_VER}"
          LLIB="-L${DEPS_DIR}/lib -lluajit-${LUAJIT_LUAVER}"

          # netfilter libs
          wget -qO- https://www.netfilter.org/pub/libnfnetlink/libnfnetlink-1.0.2.tar.bz2 | tar -xj
          wget -qO- https://www.netfilter.org/pub/libmnl/libmnl-1.0.5.tar.bz2 | tar -xj
          wget -qO- https://www.netfilter.org/pub/libnetfilter_queue/libnetfilter_queue-1.0.5.tar.bz2 | tar -xj
          patch -p1 -d libnetfilter_queue-* -i $GITHUB_WORKSPACE/zapret2/.github/workflows/libnetfilter_queue-android.patch

          for i in libmnl libnfnetlink libnetfilter_queue ; do
            (
              cd $i-*
              CFLAGS="-Os -flto=auto -Wno-implicit-function-declaration" \
              ./configure --prefix= --host=$TARGET --enable-static --disable-shared --disable-dependency-tracking
              make install -j$(nproc) DESTDIR=$DEPS_DIR
            )
            sed -i "s|^prefix=.*|prefix=$DEPS_DIR|g" $DEPS_DIR/lib/pkgconfig/$i.pc
          done

          # zapret2
          CFLAGS="-I$DEPS_DIR/include" \
          LDFLAGS="-L$DEPS_DIR/lib" \
          make -C zapret2 LUA_JIT=$LJIT LUA_CFLAGS="$LCFLAGS" LUA_LIB="$LLIB" -j$(nproc) android

          # strip
          $STRIP zapret2/binaries/my/nfqws2

          # Create output dir
          mkdir -p $GITHUB_WORKSPACE/binaries/$ABI
          cp zapret2/binaries/my/nfqws2 $GITHUB_WORKSPACE/binaries/$ABI/

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: nfqws2-${{ matrix.abi }}
          path: binaries/${{ matrix.abi }}/nfqws2

  package-module:
    name: Package Magisk Module
    runs-on: ubuntu-latest
    needs: [build-nfqws2, build-apk]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          path: binaries

      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: zapret2-apk
          path: apk-artifact

      - name: Prepare module
        run: |
          # Create bin directories (ARM only, no x86 emulator support)
          mkdir -p zapret2/bin/arm64-v8a
          mkdir -p zapret2/bin/armeabi-v7a

          # Copy binaries
          cp binaries/nfqws2-arm64-v8a/nfqws2 zapret2/bin/arm64-v8a/ || true
          cp binaries/nfqws2-armeabi-v7a/nfqws2 zapret2/bin/armeabi-v7a/ || true

          # Set version
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION="${VERSION#v}"
          VERSION_CODE=$(echo $VERSION | tr -d '.' | head -c 6)

          sed -i "s/^version=.*/version=v${VERSION}/" module.prop
          sed -i "s/^versionCode=.*/versionCode=${VERSION_CODE}/" module.prop

          # Make scripts executable
          chmod +x customize.sh service.sh uninstall.sh action.sh
          chmod +x zapret2/scripts/*.sh

      - name: Create ZIP
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION="${VERSION#v}"

          # Update update.json with current version
          sed -i "s/\"version\": \"v[^\"]*\"/\"version\": \"v${VERSION}\"/" update.json
          sed -i "s/\"versionCode\": [0-9]*/\"versionCode\": $(echo $VERSION | tr -d '.')/" update.json
          sed -i "s/zapret2-magisk-v[^\"]*\.zip/zapret2-magisk-v${VERSION}.zip/" update.json

          zip -r zapret2-magisk-v${VERSION}.zip \
            META-INF \
            module.prop \
            customize.sh \
            service.sh \
            uninstall.sh \
            action.sh \
            zapret2 \
            -x "*.git*" \
            -x "CLAUDE.md" \
            -x ".github/*"

          # Rename APK with version
          cp apk-artifact/app-release.apk zapret2-control-v${VERSION}.apk

      - name: Upload module
        uses: actions/upload-artifact@v4
        with:
          name: zapret2-magisk-module
          path: zapret2-magisk-*.zip

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: zapret2-control-apk
          path: zapret2-control-*.apk

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            zapret2-magisk-*.zip
            zapret2-control-*.apk
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
